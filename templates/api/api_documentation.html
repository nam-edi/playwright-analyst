{% extends "base.html" %} {% block title %}Documentation API{% endblock %} {%
block content %}
<div class="max-w-4xl mx-auto py-6 sm:px-6 lg:px-8">
  <div class="px-4 py-6 sm:px-0">
    <!-- Breadcrumb / Lien de retour -->
    <div class="mb-6">
      <nav class="flex" aria-label="Breadcrumb">
        <ol class="inline-flex items-center space-x-1 md:space-x-3">
          <li class="inline-flex items-center">
            <a
              href="/administration/?section=import"
              class="inline-flex items-center text-sm font-medium text-gray-700 hover:text-blue-600"
            >
              <svg
                class="w-4 h-4 mr-2"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M15 19l-7-7 7-7"
                ></path>
              </svg>
              Retour √† l'import
            </a>
          </li>
          <li>
            <div class="flex items-center">
              <svg
                class="w-6 h-6 text-gray-400"
                fill="currentColor"
                viewBox="0 0 20 20"
              >
                <path
                  fill-rule="evenodd"
                  d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z"
                  clip-rule="evenodd"
                ></path>
              </svg>
              <span class="ml-1 text-sm font-medium text-gray-500 md:ml-2"
                >Documentation API</span
              >
            </div>
          </li>
        </ol>
      </nav>
    </div>

    <!-- Header -->
    <div class="mb-8">
      <h1 class="text-3xl font-bold text-gray-900">Documentation API</h1>
      <p class="mt-2 text-lg text-gray-600">
        Int√©grez PW-Analyst directement dans votre pipeline CI/CD
      </p>
    </div>

    <!-- Pr√©sentation -->
    <div class="bg-blue-50 border border-blue-200 rounded-lg p-6 mb-8">
      <h2 class="text-lg font-semibold text-blue-900 mb-3">
        Trois m√©thodes d'import disponibles
      </h2>
      <div class="grid grid-cols-1 md:grid-cols-3 gap-4 text-sm">
        <div class="bg-white p-4 rounded border">
          <h3 class="font-medium text-gray-900 mb-2">1. Upload manuel</h3>
          <p class="text-gray-600">
            Interface web pour uploader vos fichiers JSON
          </p>
        </div>
        <div class="bg-white p-4 rounded border">
          <h3 class="font-medium text-gray-900 mb-2">2. R√©cup√©ration CI</h3>
          <p class="text-gray-600">
            R√©cup√©ration automatique depuis GitLab/GitHub
          </p>
        </div>
        <div class="bg-white p-4 rounded border border-green-300">
          <h3 class="font-medium text-green-900 mb-2">3. API REST</h3>
          <p class="text-green-700">Push direct depuis votre pipeline CI</p>
        </div>
      </div>
    </div>

    <!-- API Endpoint -->
    <div class="bg-white rounded-lg shadow border border-gray-200 p-6 mb-8">
      <h2 class="text-xl font-semibold text-gray-900 mb-4">Endpoint API</h2>

      <div class="mb-4">
        <h3 class="text-lg font-medium text-gray-900 mb-2">URL</h3>
        <div class="bg-gray-100 p-3 rounded font-mono text-sm">
          POST /api/projects/{project_id}/upload/
        </div>
      </div>

      <div class="mb-4">
        <h3 class="text-lg font-medium text-gray-900 mb-2">
          Authentification (optionnelle)
        </h3>
        <p class="text-gray-600 mb-2">
          Vous pouvez ajouter une cl√© API pour s√©curiser l'acc√®s :
        </p>
        <div class="bg-gray-100 p-3 rounded font-mono text-sm">
          Header: X-API-Key: votre_cle_api
        </div>
        <div class="mt-3 flex items-center gap-2">
          <a
            href="{% url 'api_key_help' %}"
            class="inline-flex items-center px-3 py-1 bg-blue-100 text-blue-700 rounded-lg hover:bg-blue-200 transition-colors text-sm"
          >
            <svg
              class="w-4 h-4 mr-1"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M15 7a2 2 0 012 2m4 0a6 6 0 01-7.743 5.743L11 17H9v2H7v2H4a1 1 0 01-1-1v-3.586l6.586-6.586A6 6 0 0119 9z"
              />
            </svg>
            O√π trouver ma cl√© API ?
          </a>
        </div>
      </div>
    </div>

    <!-- M√©thodes d'envoi -->
    <div class="bg-white rounded-lg shadow border border-gray-200 p-6 mb-8">
      <h2 class="text-xl font-semibold text-gray-900 mb-4">M√©thodes d'envoi</h2>

      <!-- JSON direct -->
      <div class="mb-6">
        <h3 class="text-lg font-medium text-gray-900 mb-3">
          M√©thode 1 : JSON direct dans le body
        </h3>
        <div class="bg-gray-100 p-4 rounded">
          <pre class="text-sm"><code>curl -X POST \
  -H "Content-Type: application/json" \
  -H "X-API-Key: votre_cle_api" \
  -d @results.json \
  https://votre-domaine.com/api/projects/1/upload/</code></pre>
        </div>
      </div>

      <!-- Upload fichier -->
      <div class="mb-6">
        <h3 class="text-lg font-medium text-gray-900 mb-3">
          M√©thode 2 : Upload de fichier
        </h3>
        <div class="bg-gray-100 p-4 rounded">
          <pre class="text-sm"><code>curl -X POST \
  -H "X-API-Key: votre_cle_api" \
  -F "file=@results.json" \
  https://votre-domaine.com/api/projects/1/upload/</code></pre>
        </div>
      </div>
    </div>

    <!-- Exemples d'int√©gration -->
    <div class="bg-white rounded-lg shadow border border-gray-200 p-6 mb-8">
      <h2 class="text-xl font-semibold text-gray-900 mb-4">
        Exemples d'int√©gration CI
      </h2>

      <!-- GitLab CI -->
      <div class="mb-6">
        <h3 class="text-lg font-medium text-gray-900 mb-3">GitLab CI</h3>
        <div class="bg-gray-100 p-4 rounded">
          <pre class="text-sm"><code># .gitlab-ci.yml
test:
  stage: test
  script:
    - npm ci
    - npx playwright test --reporter=json > results.json
  after_script:
    - |
      curl -X POST \
        -H "Content-Type: application/json" \
        -H "X-API-Key: $PW_ANALYST_API_KEY" \
        -d @results.json \
        "$PW_ANALYST_URL/api/projects/$PROJECT_ID/upload/"
  artifacts:
    when: always
    paths:
      - results.json</code></pre>
        </div>
      </div>

      <!-- GitHub Actions -->
      <div class="mb-6">
        <h3 class="text-lg font-medium text-gray-900 mb-3">GitHub Actions</h3>
        <div class="bg-gray-100 p-4 rounded">
          <pre class="text-sm"><code># .github/workflows/test.yml
- name: Run Playwright tests
  run: |
    npm ci
    npx playwright test --reporter=json > results.json

- name: Upload results to PW-Analyst
  if: always()
  run: |
    curl -X POST \
      -H "Content-Type: application/json" \
      -H "X-API-Key: ${{ secrets.PW_ANALYST_API_KEY }}" \
      -d @results.json \
      "${{ secrets.PW_ANALYST_URL }}/api/projects/${{ secrets.PROJECT_ID }}/upload/"</code></pre>
        </div>
      </div>
    </div>

    <!-- R√©ponses API -->
    <div class="bg-white rounded-lg shadow border border-gray-200 p-6 mb-8">
      <h2 class="text-xl font-semibold text-gray-900 mb-4">R√©ponses API</h2>

      <!-- Succ√®s -->
      <div class="mb-4">
        <h3 class="text-lg font-medium text-green-900 mb-2">Succ√®s (201)</h3>
        <div class="bg-green-50 p-4 rounded border border-green-200">
          <pre class="text-sm"><code>{
  "message": "R√©sultats import√©s avec succ√®s",
  "status": "success",
  "execution_id": 123,
  "execution_url": "https://votre-domaine.com/execution/123/",
  "project": "Mon Projet",
  "created_at": "2025-09-10T10:30:00Z"
}</code></pre>
        </div>
      </div>

      <!-- Erreurs courantes -->
      <div class="mb-4">
        <h3 class="text-lg font-medium text-red-900 mb-2">Erreurs courantes</h3>

        <div class="space-y-3">
          <div>
            <h4 class="font-medium text-gray-900">Projet non trouv√© (404)</h4>
            <div class="bg-red-50 p-3 rounded border border-red-200 text-sm">
              <code>{"error": "Projet non trouv√©", "status": "error"}</code>
            </div>
          </div>

          <div>
            <h4 class="font-medium text-gray-900">JSON invalide (400)</h4>
            <div class="bg-red-50 p-3 rounded border border-red-200 text-sm">
              <code>{"error": "JSON invalide: ...", "status": "error"}</code>
            </div>
          </div>

          <div>
            <h4 class="font-medium text-gray-900">
              Content-Type non support√© (400)
            </h4>
            <div class="bg-red-50 p-3 rounded border border-red-200 text-sm">
              <code
                >{"error": "Content-Type non support√©. Utilisez application/json
                ou multipart/form-data", "status": "error"}</code
              >
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Tips -->
    <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-6 mb-8">
      <h2 class="text-lg font-semibold text-yellow-900 mb-3">
        üí° Conseils d'utilisation
      </h2>
      <ul class="space-y-2 text-sm text-yellow-800">
        <li>
          ‚Ä¢ Assurez-vous que votre fichier JSON est au format Playwright
          reporter
        </li>
        <li>
          ‚Ä¢ Utilisez <code>if: always()</code> dans GitHub Actions pour uploader
          m√™me en cas d'√©chec des tests
        </li>
        <li>
          ‚Ä¢ Stockez votre cl√© API et l'URL dans les variables
          d'environnement/secrets de votre CI
        </li>
        <li>
          ‚Ä¢ L'ID du projet se trouve dans l'URL de votre projet dans PW-Analyst
        </li>
      </ul>
    </div>

    <!-- Bouton de retour -->
    <div class="text-center">
      <a
        href="/administration/?section=import"
        class="inline-flex items-center px-4 py-2 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500"
      >
        <svg
          class="w-4 h-4 mr-2"
          fill="none"
          stroke="currentColor"
          viewBox="0 0 24 24"
        >
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="2"
            d="M15 19l-7-7 7-7"
          ></path>
        </svg>
        Retour aux options d'import
      </a>
    </div>
  </div>
</div>
{% endblock %}
