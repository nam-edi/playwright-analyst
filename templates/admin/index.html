{% extends "admin/base_site.html" %} {% load i18n admin_urls static %} {% block
title %}{{ title }} | {{ site_title|default:_('Django site admin') }}{% endblock
%} {% block branding %}
<div class="admin-branding">
  <h1 id="site-name">
    <a href="{% url 'admin:index' %}">üé≠ PW Analyst Admin</a>
  </h1>
  <p class="admin-subtitle">Tableau de bord d'analyse des tests Playwright</p>
</div>
{% endblock %} {% block nav-global %}{% endblock %} {% block content %}
<div class="admin-dashboard">
  <!-- Header avec informations principales -->
  <div class="dashboard-header">
    <div class="header-content">
      <h1>üöÄ Bienvenue dans PW Analyst</h1>
      <p class="dashboard-subtitle">
        Analysez et surveillez vos tests Playwright en temps r√©el
      </p>
    </div>
    <div class="header-status">
      <div class="status-indicator healthy">
        <span class="status-dot"></span>
        <span class="status-text">Syst√®me op√©rationnel</span>
      </div>
    </div>
  </div>

  <!-- M√©triques rapides -->
  <div class="quick-metrics">
    <div class="metric-card primary">
      <div class="metric-icon">üèóÔ∏è</div>
      <div class="metric-content">
        <h3 id="projects-count">{{ projects_count }}</h3>
        <p>Projet{{ projects_count|pluralize }}</p>
      </div>
    </div>

    <div class="metric-card success">
      <div class="metric-icon">‚ñ∂Ô∏è</div>
      <div class="metric-content">
        <h3 id="executions-count">{{ executions_count }}</h3>
        <p>
          Ex√©cution{{ executions_count|pluralize }} totale{{
          executions_count|pluralize }}
        </p>
      </div>
    </div>

    <div class="metric-card info">
      <div class="metric-icon">üë•</div>
      <div class="metric-content">
        <h3 id="users-count">{{ users_count }}</h3>
        <p>Utilisateur{{ users_count|pluralize }}</p>
      </div>
    </div>
  </div>

  <!-- Graphique d'√©volution -->
  {% if projects_data %}
  <div class="chart-section">
    <h2>üìà √âvolution du Taux de R√©ussite par Projet</h2>
    <div class="chart-container">
      <div class="relative h-64">
        <canvas id="successRateChart" class="w-full h-full"></canvas>
      </div>
      <div class="chart-info">
        <p>
          10 derni√®res ex√©cutions par projet ({{ projects_data|length }}
          projet{{ projects_data|length|pluralize }})
        </p>
        <div class="chart-legend">
          {% for project in projects_data %}
          <div class="legend-item">
            <span
              class="legend-color"
              style="background-color: {{ project.color }};"
            ></span>
            <span class="legend-label">{{ project.name }}</span>
          </div>
          {% endfor %}
        </div>
      </div>
    </div>
  </div>
  {% endif %}
</div>

{% if projects_data %}
<script>
  document.addEventListener('DOMContentLoaded', function() {
      const successCanvas = document.getElementById('successRateChart');
      if (successCanvas) {
          const rect = successCanvas.getBoundingClientRect();
          successCanvas.width = rect.width;
          successCanvas.height = rect.height;

          const successCtx = successCanvas.getContext('2d');

          const projectsData = {{ projects_data|safe }};

          if (projectsData.length > 0) {
              const padding = 40;
              const chartWidth = successCanvas.width - 2 * padding;
              const chartHeight = successCanvas.height - 2 * padding;

              // Trouver le nombre maximum de points pour l'axe X
              const maxPoints = Math.max(...projectsData.map(p => p.data.length));

              // Dessiner la grille
              successCtx.strokeStyle = '#e5e7eb';
              successCtx.lineWidth = 1;

              for (let i = 0; i <= 10; i++) {
                  const y = padding + (chartHeight * i / 10);
                  successCtx.beginPath();
                  successCtx.moveTo(padding, y);
                  successCtx.lineTo(padding + chartWidth, y);
                  successCtx.stroke();

                  successCtx.fillStyle = '#6b7280';
                  successCtx.font = '10px system-ui';
                  successCtx.textAlign = 'right';
                  successCtx.fillText((100 - i * 10) + '%', padding - 5, y + 3);
              }

              // Ligne de base
              successCtx.beginPath();
              successCtx.moveTo(padding, padding + chartHeight);
              successCtx.lineTo(padding + chartWidth, padding + chartHeight);
              successCtx.stroke();

              // Dessiner les lignes pour chaque projet
              const allPoints = [];

              projectsData.forEach((project, projectIndex) => {
                  const projectPoints = [];

                  successCtx.strokeStyle = project.color;
                  successCtx.fillStyle = project.color;
                  successCtx.lineWidth = 2;
                  successCtx.beginPath();

                  for (let i = 0; i < project.data.length; i++) {
                      const x = padding + (chartWidth * i / (maxPoints - 1));
                      const y = padding + chartHeight - (chartHeight * project.data[i] / 100);

                      projectPoints.push({
                          x: x,
                          y: y,
                          value: project.data[i],
                          execution: i + 1,
                          project: project.name,
                          color: project.color
                      });

                      if (i === 0) {
                          successCtx.moveTo(x, y);
                      } else {
                          successCtx.lineTo(x, y);
                      }
                  }
                  successCtx.stroke();

                  // Dessiner les points
                  projectPoints.forEach(point => {
                      successCtx.beginPath();
                      successCtx.arc(point.x, point.y, 3, 0, 2 * Math.PI);
                      successCtx.fill();
                  });

                  allPoints.push(...projectPoints);
              });

              // Tooltip
              const successTooltip = document.createElement('div');
              successTooltip.style.cssText = `
                  position: absolute;
                  background: rgba(0,0,0,0.8);
                  color: white;
                  padding: 8px 12px;
                  border-radius: 4px;
                  font-size: 12px;
                  pointer-events: none;
                  z-index: 1000;
                  opacity: 0;
                  transition: opacity 0.2s;
              `;
              document.body.appendChild(successTooltip);

              successCanvas.addEventListener('mousemove', function(e) {
                  const rect = successCanvas.getBoundingClientRect();
                  const mouseX = e.clientX - rect.left;
                  const mouseY = e.clientY - rect.top;

                  let closestPoint = null;
                  let minDistance = Infinity;

                  allPoints.forEach(point => {
                      const distance = Math.sqrt(Math.pow(mouseX - point.x, 2) + Math.pow(mouseY - point.y, 2));
                      if (distance < 15 && distance < minDistance) {
                          minDistance = distance;
                          closestPoint = point;
                      }
                  });

                  if (closestPoint) {
                      successCanvas.style.cursor = 'pointer';
                      successTooltip.innerHTML = `
                          <strong>${closestPoint.project}</strong><br>
                          Ex√©cution #${closestPoint.execution}<br>
                          Taux de r√©ussite: ${closestPoint.value}%
                      `;
                      successTooltip.style.left = (e.pageX + 5) + 'px';
                      successTooltip.style.top = (e.pageY - 30) + 'px';
                      successTooltip.style.opacity = '1';
                  } else {
                      successCanvas.style.cursor = 'default';
                      successTooltip.style.opacity = '0';
                  }
              });

              successCanvas.addEventListener('mouseleave', function() {
                  successCanvas.style.cursor = 'default';
                  successTooltip.style.opacity = '0';
              });
          } else {
              successCtx.fillStyle = '#6b7280';
              successCtx.font = '14px system-ui';
              successCtx.textAlign = 'center';
              successCtx.fillText('Aucune donn√©e disponible', successCanvas.width / 2, successCanvas.height / 2);
          }
      }
  });
</script>
{% endif %}

<style>
  /* Branding personnalis√© */
  .admin-branding {
    padding: 1rem 0;
  }

  .admin-branding h1 {
    margin: 0;
  }

  .admin-branding h1 a {
    color: #417690;
    text-decoration: none;
    font-size: 1.5rem;
    font-weight: 700;
  }

  .admin-subtitle {
    margin: 0.5rem 0 0 0;
    color: #c2bf30ff;
    font-size: 0.9rem;
  }

  /* Dashboard principal */
  .admin-dashboard {
    max-width: 1200px;
    margin: 0 auto;
    padding: 2rem;
  }

  /* Header */
  .dashboard-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 2rem;
    padding: 2rem;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    border-radius: 12px;
    color: white;
  }

  .dashboard-header h1 {
    margin: 0;
    font-size: 2.5rem;
    font-weight: 700;
  }

  .dashboard-subtitle {
    margin: 0.5rem 0 0 0;
    opacity: 0.9;
    font-size: 1.2rem;
  }

  .status-indicator {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.75rem 1.5rem;
    background: rgba(255, 255, 255, 0.2);
    border-radius: 25px;
    font-size: 0.9rem;
  }

  .status-dot {
    width: 10px;
    height: 10px;
    border-radius: 50%;
    background: #10b981;
    animation: pulse 2s infinite;
  }

  @keyframes pulse {
    0%,
    100% {
      opacity: 1;
    }
    50% {
      opacity: 0.5;
    }
  }

  /* M√©triques rapides */
  .quick-metrics {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 1.5rem;
    margin-bottom: 3rem;
  }

  .metric-card {
    display: flex;
    align-items: center;
    gap: 1rem;
    padding: 1.5rem;
    background: white;
    border-radius: 12px;
    box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
    border-left: 4px solid;
    transition: transform 0.2s ease;
  }

  .metric-card:hover {
    transform: translateY(-2px);
  }

  .metric-card.primary {
    border-left-color: #3b82f6;
  }
  .metric-card.success {
    border-left-color: #10b981;
  }
  .metric-card.warning {
    border-left-color: #f59e0b;
  }
  .metric-card.info {
    border-left-color: #06b6d4;
  }

  .metric-icon {
    font-size: 2rem;
    opacity: 0.8;
  }

  .metric-content h3 {
    margin: 0;
    font-size: 2rem;
    font-weight: bold;
    color: #374151;
  }

  .metric-content p {
    margin: 0.25rem 0 0 0;
    color: #6b7280;
    font-size: 0.9rem;
  }

  /* Section graphique */
  .chart-section {
    margin-bottom: 3rem;
  }

  .chart-section h2 {
    color: #c2b828ff;
    margin-bottom: 1.5rem;
    font-size: 1.5rem;
    font-weight: 600;
  }

  .chart-container {
    background: white;
    border-radius: 12px;
    padding: 1.5rem;
    box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
  }

  .chart-info {
    margin-top: 1rem;
    text-align: center;
  }

  .chart-info p {
    color: #6b7280;
    font-size: 0.9rem;
    margin: 0 0 1rem 0;
  }

  /* L√©gende du graphique */
  .chart-legend {
    display: flex;
    flex-wrap: wrap;
    gap: 1rem;
    justify-content: center;
    margin-top: 0.5rem;
  }

  .legend-item {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    font-size: 0.8rem;
  }

  .legend-color {
    width: 12px;
    height: 12px;
    border-radius: 2px;
    display: inline-block;
  }

  .legend-label {
    color: #374151;
    font-weight: 500;
  }

  /* Classe helper pour la hauteur */
  .h-64 {
    height: 16rem;
  }

  .relative {
    position: relative;
  }

  .w-full {
    width: 100%;
  }

  .h-full {
    height: 100%;
  }

  /* Design responsive */
  @media (max-width: 768px) {
    .admin-dashboard {
      padding: 1rem;
    }

    .dashboard-header {
      flex-direction: column;
      text-align: center;
      gap: 1rem;
      padding: 1.5rem;
    }

    .dashboard-header h1 {
      font-size: 2rem;
    }

    .quick-metrics {
      grid-template-columns: repeat(2, 1fr);
      gap: 1rem;
    }
  }

  @media (max-width: 480px) {
    .quick-metrics {
      grid-template-columns: 1fr;
    }
  }
</style>
{% endblock %}
