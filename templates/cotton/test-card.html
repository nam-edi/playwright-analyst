{% load test_filters %}
<c-vars test />

<div
  class="bg-white rounded-lg shadow-sm border border-gray-200 p-4 hover:shadow-md transition-shadow cursor-pointer flex flex-col h-full"
  hx-get="{% url 'test_detail' test.id %}"
  hx-target="#test-detail-panel"
>
  <!-- En-tête du test -->
  <div class="mb-3">
    <div class="flex-1">
      <h4 class="font-medium text-gray-900 mb-1 flex items-center">
        {{ test.title }}
        <!-- Pictogramme de commentaire -->
        {% if test.comment %}
        <div class="relative group ml-2">
          <span
            class="inline-flex items-center justify-center w-5 h-5 rounded-full bg-yellow-100 text-yellow-600 cursor-help"
          >
            <svg class="w-3 h-3" fill="currentColor" viewBox="0 0 20 20">
              <path
                fill-rule="evenodd"
                d="M18 10c0 3.866-3.582 7-8 7a8.841 8.841 0 01-4.083-.98L2 17l1.338-3.123C2.493 12.767 2 11.434 2 10c0-3.866 3.582-7 8-7s8 3.134 8 7zM7 9H5v2h2V9zm8 0h-2v2h2V9zM9 9h2v2H9V9z"
                clip-rule="evenodd"
              ></path>
            </svg>
          </span>
          <!-- Tooltip -->
          <div
            class="absolute left-full top-1/2 transform -translate-y-1/2 ml-2 w-64 p-3 bg-white text-gray-800 text-xs rounded-lg shadow-xl border border-gray-300 opacity-0 group-hover:opacity-100 transition-opacity duration-200 pointer-events-none z-20"
            style="
              box-shadow: 0 10px 25px -3px rgba(0, 0, 0, 0.1),
                0 4px 6px -2px rgba(0, 0, 0, 0.05),
                0 0 0 1px rgba(0, 0, 0, 0.05);
            "
          >
            {{ test.comment }}
            <!-- Flèche pointant vers la gauche avec bordure -->
            <div
              class="absolute right-full top-1/2 transform -translate-y-1/2 w-0 h-0 border-t-5 border-b-5 border-r-5 border-transparent border-r-gray-300"
              style="border-width: 5px 5px 5px 0"
            ></div>
          </div>
        </div>
        {% endif %}
      </h4>
      <div class="flex items-center gap-2">
        <p
          class="text-sm text-gray-600 truncate cursor-pointer hover:text-gray-800 transition-colors max-w-lg"
          title="{{ test.file_path }}:{{ test.line }}"
          onclick="navigator.clipboard.writeText('{{ test.file_path }}:{{ test.line }}'); event.stopPropagation(); this.classList.add('text-green-600'); setTimeout(() => this.classList.remove('text-green-600'), 1000);"
        >
          {% if test.file_path|length > 190 %} ...{{ test.file_path|slice:"-200"
          }}:{{ test.line }} {% else %} {{ test.file_path }}:{{ test.line }} {%
          endif %}
        </p>
        <button
          class="text-gray-400 hover:text-gray-600 transition-colors p-1"
          onclick="navigator.clipboard.writeText('{{ test.file_path }}:{{ test.line }}'); event.stopPropagation(); this.classList.add('text-green-600'); setTimeout(() => this.classList.remove('text-green-600'), 1000);"
          title="Copier le chemin"
        >
          <svg
            class="w-3 h-3"
            fill="none"
            stroke="currentColor"
            viewBox="0 0 24 24"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"
            ></path>
          </svg>
        </button>
      </div>
      {% if test.story %}
      <p class="text-xs text-gray-500 mt-1">
        {{ test.story|linebreaks_simple|safe }}
      </p>
      {% endif %}

      <!-- Tags du test -->
      {% if test.tags.exists %}
      <div class="mt-2">
        <div class="flex flex-wrap gap-1">
          {% for tag in test.tags.all %}
          <c-tag name="{{ tag.name }}" color="{{ tag.color }}" />
          {% endfor %}
        </div>
      </div>
      {% endif %}
    </div>
  </div>

  <!-- Contenu principal qui grandit pour pousser le footer vers le bas -->
  <div class="flex-1">
    <!-- Jauge des dernières exécutions -->
    <c-test-execution-gauge :test="test" />

    <!-- Informations optionnelles des résultats -->
    {% with latest_result=test.results.first %} {% if latest_result %}
    <!-- Durée moyenne des dernières exécutions réussies -->
    <div class="mb-3 text-xs">
      <div class="flex items-center gap-2">
        <span class="text-gray-600"
          >Durée moyenne (5 derniers tests réussis):</span
        >
        {% with avg_duration=test|average_duration_last_passed %} {% if
        avg_duration %}
        <span class="font-medium">{{ avg_duration|duration_format }}</span>
        {% else %}
        <span class="font-medium text-gray-400">Aucun test réussi</span>
        {% endif %} {% endwith %}
      </div>
    </div>

    <!-- Erreur si présente -->
    {% if latest_result.errors and latest_result.status != 'passed' %}
    <div class="mb-3" onclick="event.stopPropagation()">
      <details class="group">
        <summary class="cursor-pointer text-xs text-red-600 hover:text-red-800">
          Voir la dernière erreur →
        </summary>
        <div class="mt-2 p-3 bg-red-50 rounded border-l-4 border-red-400">
          {% for error in latest_result.errors %}
          <pre class="text-xs text-red-700 whitespace-pre-wrap">
{{ error.message|default:error }}</pre
          >
          {% endfor %}
        </div>
      </details>
    </div>
    {% endif %} {% endif %} {% endwith %}
  </div>

  <!-- Footer -->
  <div
    class="flex justify-between items-center text-xs text-gray-500 border-t pt-2"
  >
    <span>{{ test.file_path|split:"/"| last }}</span>
    <span>
      {% with latest_result=test.results.first %} {% if latest_result %} {{
      latest_result.start_time|date:"d/m/Y H:i" }} {% else %} Créé le {{
      test.created_at|date:"d/m/Y" }} {% endif %} {% endwith %}
    </span>
  </div>
</div>
