name: Security & Dependencies Check

# VÃ©rifications de sÃ©curitÃ© quotidiennes et sur les changements de requirements.txt
on:
  schedule:
    - cron: "0 2 * * *" # Tous les jours Ã  2h du matin UTC
  push:
    paths:
      - "requirements.txt"
      - "requirements-dev.txt"
  workflow_dispatch:

jobs:
  security-audit:
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ”„ Checkout du code
        uses: actions/checkout@v4

      - name: ğŸ Configuration de Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.13"

      - name: ğŸ“¥ Installation des dÃ©pendances
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: ğŸ›¡ï¸ Audit de sÃ©curitÃ© avec pip-audit
        run: |
          pip install pip-audit
          pip-audit --format=json --output=security-report.json
          pip-audit --format=text
        continue-on-error: true

      - name: ğŸ”’ Analyse de sÃ©curitÃ© avec Bandit
        run: |
          pip install bandit
          bandit -r . -f json -o bandit-report.json
          bandit -r . -f txt
        continue-on-error: true

      - name: ğŸ” VÃ©rification des secrets avec detect-secrets
        run: |
          pip install detect-secrets
          detect-secrets scan --all-files --baseline .secrets.baseline
        continue-on-error: true

      - name: ğŸ“Š Upload des rapports de sÃ©curitÃ©
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: security-reports
          path: |
            security-report.json
            bandit-report.json
          retention-days: 30

      - name: ğŸ“ CrÃ©er issue si vulnÃ©rabilitÃ©s critiques
        if: failure()
        uses: actions/github-script@v6
        with:
          script: |
            const title = 'ğŸš¨ VulnÃ©rabilitÃ©s de sÃ©curitÃ© dÃ©tectÃ©es';
            const body = `
            ## ğŸš¨ Rapport de sÃ©curitÃ© automatique

            **Date :** ${new Date().toISOString()}
            **Workflow :** Security & Dependencies Check
            **Commit :** \`${{ github.sha }}\`

            Des vulnÃ©rabilitÃ©s de sÃ©curitÃ© ont Ã©tÃ© dÃ©tectÃ©es dans les dÃ©pendances ou le code.

            ### Actions recommandÃ©es :
            1. ğŸ“‹ Consulter les rapports d'artefacts dans cette exÃ©cution
            2. ğŸ”§ Mettre Ã  jour les dÃ©pendances vulnÃ©rables
            3. ğŸ› ï¸ Corriger les problÃ¨mes de code identifiÃ©s par Bandit
            4. âœ… Relancer les vÃ©rifications

            ### Liens utiles :
            - [ExÃ©cution du workflow](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
            - [Guide de sÃ©curitÃ© Django](https://docs.djangoproject.com/en/stable/topics/security/)

            > Cette issue a Ã©tÃ© crÃ©Ã©e automatiquement. Fermez-la une fois les problÃ¨mes rÃ©solus.
            `;

            // VÃ©rifie si une issue similaire existe dÃ©jÃ 
            const { data: issues } = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'security,automated'
            });

            const existingIssue = issues.find(issue => issue.title === title);

            if (!existingIssue) {
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: title,
                body: body,
                labels: ['security', 'automated', 'bug']
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: existingIssue.number,
                body: `ğŸ”„ **Nouvelle dÃ©tection de vulnÃ©rabilitÃ©s**\n\nDate: ${new Date().toISOString()}\nCommit: \`${{ github.sha }}\`\n\n[Voir les dÃ©tails](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})`
              });
            }

  dependency-check:
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ”„ Checkout du code
        uses: actions/checkout@v4

      - name: ğŸ Configuration de Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.13"

      - name: ğŸ“¦ Analyse des dÃ©pendances obsolÃ¨tes
        run: |
          python -m pip install --upgrade pip
          pip install pip-check-reqs pip-autoremove

          echo "ğŸ“Š VÃ©rification des dÃ©pendances manquantes :"
          pip-missing-reqs . || true

          echo "ğŸ“Š VÃ©rification des dÃ©pendances inutilisÃ©es :"
          pip-extra-reqs . || true

          echo "ğŸ“Š DÃ©pendances obsolÃ¨tes :"
          pip list --outdated

      - name: ğŸ“ˆ Rapport de taille des dÃ©pendances
        run: |
          pip install -r requirements.txt
          echo "ğŸ“Š Taille totale des dÃ©pendances installÃ©es :"
          pip list --format=freeze | wc -l

          echo "ğŸ“Š Top 10 des plus gros packages :"
          pip show $(pip list --format=freeze | cut -d'=' -f1) | grep -E "^Name|^Version|^Location" | paste - - - | head -10

  # Job hebdomadaire pour nettoyer les anciennes branches
  cleanup:
    runs-on: ubuntu-latest
    if: github.event.schedule
    steps:
      - name: ğŸ”„ Checkout du code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: ğŸ§¹ Nettoyage des branches mergÃ©es
        run: |
          echo "ğŸ§¹ Nettoyage des branches locales mergÃ©es..."

          # RÃ©cupÃ¨re toutes les branches
          git fetch --all --prune

          # Liste les branches mergÃ©es (exclut main et develop)
          MERGED_BRANCHES=$(git branch -r --merged origin/main | grep -v 'origin/main' | grep -v 'origin/HEAD' | sed 's/origin\///' || true)

          if [ -n "$MERGED_BRANCHES" ]; then
            echo "ğŸ—‘ï¸ Branches mergÃ©es trouvÃ©es :"
            echo "$MERGED_BRANCHES"

            # Note: La suppression automatique des branches est dÃ©sactivÃ©e pour la sÃ©curitÃ©
            # Pour l'activer, dÃ©commentez les lignes suivantes :
            # for branch in $MERGED_BRANCHES; do
            #   echo "Suppression de la branche : $branch"
            #   git push origin --delete "$branch" || true
            # done

            echo "â„¹ï¸ Suppression automatique dÃ©sactivÃ©e. Supprimez manuellement si nÃ©cessaire."
          else
            echo "âœ… Aucune branche mergÃ©e Ã  nettoyer."
          fi
