name: Pull Request Checks

# Checks spÃ©cifiques pour les PR vers main
on:
  pull_request:
    branches: [main]
    types: [opened, synchronize, reopened, ready_for_review]

# Permissions nÃ©cessaires pour commenter les PR
permissions:
  contents: read
  pull-requests: write
  checks: write

jobs:
  # VÃ©rifications de base requises pour merger
  required-checks:
    runs-on: ubuntu-latest
    if: github.event.pull_request.draft == false

    steps:
      - name: ğŸ”„ Checkout du code
        uses: actions/checkout@v4
        with:
          # RÃ©cupÃ¨re l'historique complet pour les comparaisons
          fetch-depth: 0

      - name: ğŸ Configuration de Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.13"

      - name: ğŸ“¥ Installation des dÃ©pendances
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: ğŸ“Š Tests avec couverture obligatoire
        run: |
          pip install coverage
          coverage run --source='.' manage.py test --verbosity=2
          coverage report --fail-under=40  # Ã‰chec si couverture < 40%
          coverage xml
        env:
          DJANGO_SETTINGS_MODULE: pw_analyst.settings

      - name: ğŸ” VÃ©rifications de code strictes
        run: |
          pip install flake8 black isort

          # VÃ©rification du formatage avec Black
          black --check --diff .

          # VÃ©rification du tri des imports avec isort
          isort --check-only --diff .

          # VÃ©rifications flake8 (Ã©chec sur warnings)
          flake8 . --count --max-complexity=10 --max-line-length=127 --statistics

      - name: ğŸ—„ï¸ VÃ©rification des migrations
        run: |
          python manage.py makemigrations --check --dry-run
          python manage.py migrate --run-syncdb
        env:
          DJANGO_SETTINGS_MODULE: pw_analyst.settings

      - name: ğŸ”’ Tests de sÃ©curitÃ© obligatoires
        run: |
          pip install bandit safety

          # Bandit pour l'analyse statique de sÃ©curitÃ©
          bandit -r . -ll  # Niveau medium et high seulement

          # Safety pour les vulnÃ©rabilitÃ©s des dÃ©pendances
          safety check --json

      - name: ğŸ“ Commentaire automatique sur la PR
        if: always()
        uses: actions/github-script@v6
        with:
          script: |
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });

            // Supprime les anciens commentaires du bot
            const botComments = comments.filter(comment =>
              comment.user.type === 'Bot' &&
              comment.body.includes('ğŸ¤– Rapport automatique')
            );

            for (const comment of botComments) {
              await github.rest.issues.deleteComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: comment.id,
              });
            }

            // CrÃ©e un nouveau commentaire
            const jobStatus = '${{ job.status }}';
            const emoji = jobStatus === 'success' ? 'âœ…' : 'âŒ';
            const status = jobStatus === 'success' ? 'Toutes les vÃ©rifications passent' : 'Certaines vÃ©rifications ont Ã©chouÃ©';

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: `ğŸ¤– **Rapport automatique des vÃ©rifications**

            ${emoji} **Statut :** ${status}

            **DÃ©tails :**
            - Tests Django avec couverture (â‰¥40%)
            - VÃ©rifications de code (Black, isort, flake8)
            - VÃ©rifications de migrations
            - Tests de sÃ©curitÃ© (Bandit, Safety)

            **Branch :** \`${{ github.head_ref }}\`
            **Commit :** \`${{ github.event.pull_request.head.sha }}\`

            ${jobStatus === 'failure' ? 'âš ï¸ Veuillez corriger les problÃ¨mes avant de merger.' : 'ğŸ‰ Cette PR est prÃªte Ã  Ãªtre mergÃ©e !'}
            `
            });

  # Job pour analyser les changements de performance
  performance-check:
    runs-on: ubuntu-latest
    if: github.event.pull_request.draft == false

    steps:
      - name: ğŸ”„ Checkout du code
        uses: actions/checkout@v4

      - name: ğŸ Configuration de Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.13"

      - name: ğŸ“¥ Installation des dÃ©pendances
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install django-extensions memory-profiler

      - name: âš¡ Test de performance des migrations
        run: |
          echo "ğŸ”„ Test des temps de migration..."
          time python manage.py migrate --run-syncdb
        env:
          DJANGO_SETTINGS_MODULE: pw_analyst.settings

      - name: ğŸ“Š Analyse de la complexitÃ© du code
        run: |
          pip install radon xenon

          echo "ğŸ“Š ComplexitÃ© cyclomatique :"
          radon cc . -s -a

          echo "ğŸ“Š Index de maintenabilitÃ© :"
          radon mi . -s

          # Ã‰chec si complexitÃ© trop Ã©levÃ©e
          xenon --max-absolute B --max-modules A --max-average A .
        continue-on-error: true
