{% load test_filters %} {% if total_count > 0 %} {% widthratio pass_count
total_count 100 as success_rate %} {% with success_rate|floatformat:0 as
success_rate_number %} {% if fail_count == 0 %}
<!-- 100% de réussite (aucun échec) - VERT -->
<li
  class="rounded-lg border-l-4 border-green-400 bg-white shadow-sm hover:shadow-md hover:bg-green-50 transition-all duration-200 transform hover:-translate-y-1"
>
  {% else %}
  <!-- Calcul de la réussite: si >= 90% alors orange, sinon rouge -->
  {% if pass_count|is_success_rate_90_or_more:total_count %}
  <!-- 90-99% de réussite - ORANGE -->
</li>

<li
  class="rounded-lg border-l-4 border-orange-400 bg-white shadow-sm hover:shadow-md hover:bg-orange-50 transition-all duration-200 transform hover:-translate-y-1"
>
  {% else %}
  <!-- < 90% de réussite - ROUGE -->
</li>

<li
  class="rounded-lg border-l-4 border-red-400 bg-white shadow-sm hover:shadow-md hover:bg-red-50 transition-all duration-200 transform hover:-translate-y-1"
>
  {% endif %} {% endif %} {% endwith %} {% else %}
  <!-- Pas de tests - GRIS -->
</li>

<li
  class="rounded-lg border-l-4 border-gray-300 bg-white shadow-sm hover:shadow-md hover:bg-gray-50 transition-all duration-200 transform hover:-translate-y-1"
>
  {% endif %}
  <div class="px-6 py-5">
    <div class="space-y-4">
      <!-- En-tête de l'exécution -->
      <div
        class="flex flex-col lg:flex-row lg:items-start lg:justify-between gap-4"
      >
        <div class="flex-1 min-w-0">
          <a
            href="{% url 'execution_detail' execution.id %}"
            class="block group"
          >
            {% if execution.raw_json.config.metadata.name or
            execution.raw_json.config.metadata.environment %}
            <div class="mb-3">
              {% if execution.raw_json.config.metadata.name %}
              <h3
                class="text-lg font-bold text-gray-900 group-hover:text-blue-700 transition-colors mb-1"
              >
                {{ execution.raw_json.config.metadata.name }}
              </h3>
              {% endif %} {% if execution.raw_json.config.metadata.environment
              %}
              <div
                class="inline-flex items-center px-2.5 py-1 rounded-full text-xs font-medium bg-emerald-100 text-emerald-800 border border-emerald-200"
              >
                <svg
                  class="w-3 h-3 mr-1"
                  fill="currentColor"
                  viewBox="0 0 20 20"
                >
                  <path
                    fill-rule="evenodd"
                    d="M3 4a1 1 0 011-1h12a1 1 0 011 1v2a1 1 0 01-1 1H4a1 1 0 01-1-1V4zM3 10a1 1 0 011-1h6a1 1 0 011 1v6a1 1 0 01-1 1H4a1 1 0 01-1-1v-6zM14 9a1 1 0 00-1 1v6a1 1 0 001 1h2a1 1 0 001-1v-6a1 1 0 00-1-1h-2z"
                    clip-rule="evenodd"
                  ></path>
                </svg>
                {{ execution.raw_json.config.metadata.environment }}
              </div>
              {% endif %}
            </div>
            {% else %}
            <h3
              class="text-lg font-bold text-gray-900 group-hover:text-blue-700 transition-colors mb-3"
            >
              Exécution #{{ execution.id }}
            </h3>
            {% endif %}
          </a>

          <!-- Badges d'informations -->
          {% if execution.git_commit_short_hash or execution.git_branch or
          execution.ci_build_href or execution.comment %}
          <div class="flex flex-wrap items-center gap-2">
            {% if execution.git_commit_short_hash %}
            <span
              class="inline-flex items-center px-2.5 py-1 rounded-md text-xs font-mono bg-gray-100 text-gray-700 border border-gray-200 hover:bg-gray-200 transition-colors"
            >
              <svg
                class="w-3 h-3 mr-1.5"
                fill="currentColor"
                viewBox="0 0 20 20"
              >
                <path
                  fill-rule="evenodd"
                  d="M12.316 3.051a1 1 0 01.633 1.265l-4 12a1 1 0 11-1.898-.632l4-12a1 1 0 011.265-.633zM5.707 6.293a1 1 0 010 1.414L3.414 10l2.293 2.293a1 1 0 11-1.414 1.414l-3-3a1 1 0 010-1.414l3-3a1 1 0 011.414 0zm8.586 0a1 1 0 011.414 0l3 3a1 1 0 010 1.414l-3 3a1 1 0 11-1.414-1.414L16.586 10l-2.293-2.293a1 1 0 010-1.414z"
                  clip-rule="evenodd"
                />
              </svg>
              {{ execution.git_commit_short_hash }}
            </span>
            {% endif %} {% if execution.git_branch %}
            <span
              class="inline-flex items-center px-2.5 py-1 rounded-full text-xs font-medium bg-blue-100 text-blue-800 border border-blue-200"
            >
              <svg
                class="w-3 h-3 mr-1.5"
                fill="currentColor"
                viewBox="0 0 20 20"
              >
                <path
                  fill-rule="evenodd"
                  d="M6 3a1 1 0 000 2c.737 0 1.333.327 1.333 1v3c0 .673-.326 1-1.333 1a1 1 0 000 2c1.457 0 2.667-.673 2.667-2V6c0-1.327-1.21-2-2.667-2z"
                  clip-rule="evenodd"
                ></path>
                <path
                  fill-rule="evenodd"
                  d="M14 3a1 1 0 100 2c.737 0 1.333.327 1.333 1v3c0 .673-.326 1-1.333 1a1 1 0 100 2c1.457 0 2.667-.673 2.667-2V6c0-1.327-1.21-2-2.667-2z"
                  clip-rule="evenodd"
                ></path>
              </svg>
              {{ execution.git_branch }}
            </span>
            {% endif %} {% if execution.ci_build_href %}
            <a
              href="{{ execution.ci_build_href }}"
              target="_blank"
              rel="noopener noreferrer"
              class="inline-flex items-center px-2.5 py-1 rounded-full text-xs font-medium bg-purple-100 text-purple-800 hover:bg-purple-200 transition-colors border border-purple-200"
            >
              <svg
                class="w-3 h-3 mr-1.5"
                fill="currentColor"
                viewBox="0 0 20 20"
              >
                <path
                  fill-rule="evenodd"
                  d="M12.586 4.586a2 2 0 112.828 2.828l-3 3a2 2 0 01-2.828 0 1 1 0 00-1.414 1.414 4 4 0 005.656 0l3-3a4 4 0 00-5.656-5.656l-1.5 1.5a1 1 0 101.414 1.414l1.5-1.5zm-5 5a2 2 0 012.828 0 1 1 0 101.414-1.414 4 4 0 00-5.656 0l-3 3a4 4 0 105.656 5.656l1.5-1.5a1 1 0 10-1.414-1.414l-1.5 1.5a2 2 0 11-2.828-2.828l3-3z"
                  clip-rule="evenodd"
                ></path>
              </svg>
              Build CI
              <svg
                class="ml-1 h-3 w-3"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"
                ></path>
              </svg>
            </a>
            {% endif %} {% if execution.comment %}
            <button
              type="button"
              onclick="openCommentModal({{ execution.id }})"
              class="inline-flex items-center px-2.5 py-1 rounded-full text-xs font-medium bg-amber-100 text-amber-800 hover:bg-amber-200 transition-colors border border-amber-200 cursor-pointer"
              title="Voir le commentaire"
            >
              <svg
                class="w-3 h-3 mr-1.5"
                fill="currentColor"
                viewBox="0 0 20 20"
              >
                <path
                  fill-rule="evenodd"
                  d="M18 10c0 3.866-3.582 7-8 7a8.841 8.841 0 01-4.083-.98L2 17l1.338-3.123C2.493 12.767 2 11.434 2 10c0-3.866 3.582-7 8-7s8 3.134 8 7zM7 9H5v2h2V9zm8 0h-2v2h2V9zM9 9h2v2H9V9z"
                  clip-rule="evenodd"
                ></path>
              </svg>
              Commentaire
            </button>
            {% endif %}
          </div>
          {% endif %}
        </div>

        <!-- Durée et informations techniques -->
        <div class="bg-gray-50 rounded-lg p-3 border border-gray-200 min-w-fit">
          <div class="flex flex-col space-y-2 text-right">
            <div class="flex items-center justify-end space-x-2">
              <svg
                class="w-4 h-4 text-gray-400"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"
                ></path>
              </svg>
              <span class="text-sm font-medium text-gray-600">
                {{ execution.start_time|date:"d/m/Y à H:i" }}
              </span>
            </div>
            <div class="flex items-center justify-end space-x-2">
              <svg
                class="w-4 h-4 text-gray-400"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"
                ></path>
              </svg>
              <span class="text-sm font-medium text-gray-900">
                {{ execution.duration|duration_detailed }}
              </span>
            </div>
          </div>
        </div>
      </div>

      <!-- Statistiques des tests -->
      <a href="{% url 'execution_detail' execution.id %}" class="block group">
        <div
          class="bg-gradient-to-r from-gray-50 to-gray-100 rounded-lg p-4 group-hover:from-blue-50 group-hover:to-blue-100 transition-all duration-200 border border-gray-200"
        >
          <div class="flex items-center justify-between mb-3">
            <h4
              class="text-sm font-semibold text-gray-700 group-hover:text-blue-700"
            >
              Résultats des tests
            </h4>
            <svg
              class="w-4 h-4 text-gray-400 group-hover:text-blue-500 transform group-hover:translate-x-1 transition-transform"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M9 5l7 7-7 7"
              ></path>
            </svg>
          </div>

          <div class="grid grid-cols-2 sm:grid-cols-4 gap-3 mb-4">
            <!-- PASS -->
            <div
              class="text-center bg-white rounded-lg p-3 shadow-sm border border-green-200 hover:border-green-300 transition-colors"
            >
              <div class="flex items-center justify-center mb-2">
                <div class="w-2.5 h-2.5 bg-green-500 rounded-full mr-2"></div>
                <span class="text-xs font-semibold text-gray-700">PASS</span>
              </div>
              <span class="text-lg font-bold text-green-700"
                >{{ pass_count }}</span
              >
            </div>

            <!-- FAIL -->
            <div
              class="text-center bg-white rounded-lg p-3 shadow-sm border border-red-200 hover:border-red-300 transition-colors"
            >
              <div class="flex items-center justify-center mb-2">
                <div class="w-2.5 h-2.5 bg-red-500 rounded-full mr-2"></div>
                <span class="text-xs font-semibold text-gray-700">FAIL</span>
              </div>
              <span class="text-lg font-bold text-red-700"
                >{{ fail_count }}</span
              >
            </div>

            <!-- SKIP -->
            <div
              class="text-center bg-white rounded-lg p-3 shadow-sm border border-yellow-200 hover:border-yellow-300 transition-colors"
            >
              <div class="flex items-center justify-center mb-2">
                <div class="w-2.5 h-2.5 bg-yellow-500 rounded-full mr-2"></div>
                <span class="text-xs font-semibold text-gray-700">SKIP</span>
              </div>
              <span class="text-lg font-bold text-yellow-700"
                >{{ skip_count }}</span
              >
            </div>

            <!-- Total -->
            <div
              class="text-center bg-white rounded-lg p-3 shadow-sm border border-gray-200 hover:border-gray-300 transition-colors"
            >
              <div class="flex items-center justify-center mb-2">
                <svg
                  class="w-3 h-3 mr-2 text-gray-500"
                  fill="currentColor"
                  viewBox="0 0 20 20"
                >
                  <path
                    fill-rule="evenodd"
                    d="M3 4a1 1 0 011-1h12a1 1 0 011 1v2a1 1 0 01-1 1H4a1 1 0 01-1-1V4zM3 10a1 1 0 011-1h6a1 1 0 011 1v6a1 1 0 01-1 1H4a1 1 0 01-1-1v-6zM14 9a1 1 0 00-1 1v6a1 1 0 001 1h2a1 1 0 001-1v-6a1 1 0 00-1-1h-2z"
                    clip-rule="evenodd"
                  ></path>
                </svg>
                <span class="text-xs font-semibold text-gray-700">TOTAL</span>
              </div>
              <span class="text-lg font-bold text-gray-900"
                >{{ total_count }}</span
              >
            </div>
          </div>

          <!-- Barre de progression améliorée -->
          <div class="space-y-3">
            <div
              class="flex justify-between items-center text-xs text-gray-600"
            >
              <span class="font-medium">Taux de réussite</span>
              <span class="bg-gray-100 px-2 py-1 rounded text-gray-800"
                >{{ total_count }} test{{ total_count|pluralize }}</span
              >
            </div>
            <div class="relative">
              {% if total_count > 0 %} {% widthratio pass_count total_count 100
              as success_rate %}
              <!-- Barre de progression avec nouvelle logique de couleur -->
              <div
                class="bg-gray-200 rounded-full overflow-hidden h-4 w-full shadow-inner"
              >
                {% if fail_count == 0 %}
                <!-- 100% de réussite (aucun échec) - VERT -->
                <div
                  class="h-full bg-gradient-to-r from-green-400 to-green-500 transition-all duration-500 shadow-sm"
                  style="width: 100%"
                ></div>
                {% else %}
                <!-- Calcul de la réussite: si >= 90% alors orange, sinon rouge -->
                {% if pass_count|is_success_rate_90_or_more:total_count %}
                <!-- 90-99% de réussite - ORANGE -->
                <div
                  class="h-full bg-gradient-to-r from-orange-400 to-orange-500 transition-all duration-500 shadow-sm"
                  style="width: {{ success_rate }}%"
                ></div>
                {% else %}
                <!-- < 90% de réussite - ROUGE -->
                <div
                  class="h-full bg-gradient-to-r from-red-400 to-red-500 transition-all duration-500 shadow-sm"
                  style="width: {{ success_rate }}%"
                ></div>
                {% endif %} {% endif %}
              </div>
              <!-- Étiquette de pourcentage -->
              <div class="absolute inset-0 flex items-center justify-center">
                <span class="text-xs font-bold text-white drop-shadow-lg">
                  {% if fail_count == 0 %}100{% else %}{{ success_rate }}{%
                  endif %}% réussite
                </span>
              </div>
              {% else %}
              <div
                class="bg-gray-200 rounded-full overflow-hidden h-4 w-full shadow-inner"
              >
                <div class="h-full bg-gray-400 w-full"></div>
              </div>
              <div class="absolute inset-0 flex items-center justify-center">
                <span class="text-xs font-bold text-white drop-shadow-lg">
                  Aucun test
                </span>
              </div>
              {% endif %}
            </div>
          </div>
        </div>
      </a>
    </div>
  </div>
</li>

<!-- Modale pour le commentaire (en dehors de la balise li) -->
{% if execution.comment %}
<div
  id="comment-modal-{{ execution.id }}"
  class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50"
  style="display: none"
>
  <div
    class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white"
  >
    <div class="mt-3">
      <!-- En-tête de la modale -->
      <div class="flex items-center justify-between mb-4">
        <div class="flex items-center space-x-2">
          <svg
            class="w-5 h-5 text-blue-500"
            fill="currentColor"
            viewBox="0 0 20 20"
          >
            <path
              fill-rule="evenodd"
              d="M18 10c0 3.866-3.582 7-8 7a8.841 8.841 0 01-4.083-.98L2 17l1.338-3.123C2.493 12.767 2 11.434 2 10c0-3.866 3.582-7 8-7s8 3.134 8 7zM7 9H5v2h2V9zm8 0h-2v2h2V9zM9 9h2v2H9V9z"
              clip-rule="evenodd"
            ></path>
          </svg>
          <h3 class="text-lg font-medium text-gray-900">
            Commentaire d'exécution
          </h3>
        </div>
        <button
          type="button"
          onclick="closeCommentModal({{ execution.id }})"
          class="text-gray-400 hover:text-gray-600 transition-colors"
          title="Fermer"
        >
          <svg
            class="w-6 h-6"
            fill="none"
            stroke="currentColor"
            viewBox="0 0 24 24"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M6 18L18 6M6 6l12 12"
            ></path>
          </svg>
        </button>
      </div>

      <!-- Date et heure de l'exécution -->
      <div class="mb-4 p-3 bg-gray-50 rounded-lg">
        <p class="text-sm text-gray-600">
          Exécution du {{ execution.start_time|date:"d/m/Y à H:i" }}
        </p>
      </div>

      <!-- Contenu du commentaire -->
      <div class="mb-6">
        <div class="p-4 bg-blue-50 rounded-lg border border-blue-200">
          <p class="text-sm text-gray-800 whitespace-pre-wrap leading-relaxed">
            {{ execution.comment }}
          </p>
        </div>
      </div>

      <!-- Boutons d'action -->
      <div class="flex justify-end space-x-3">
        <button
          type="button"
          onclick="closeCommentModal({{ execution.id }})"
          class="px-4 py-2 bg-gray-200 text-gray-800 text-sm font-medium rounded-md hover:bg-gray-300 transition-colors"
        >
          Fermer
        </button>
      </div>
    </div>
  </div>
</div>
{% endif %}

<script>
  function openCommentModal(executionId) {
    const modal = document.getElementById("comment-modal-" + executionId);
    if (modal) {
      modal.style.display = "block";
      document.body.style.overflow = "hidden"; // Empêche le scroll de la page
    }
  }

  function closeCommentModal(executionId) {
    const modal = document.getElementById("comment-modal-" + executionId);
    if (modal) {
      modal.style.display = "none";
      document.body.style.overflow = "auto"; // Restaure le scroll de la page
    }
  }

  // Fermer la modale en cliquant à l'extérieur
  document.addEventListener("click", function (event) {
    if (event.target.classList.contains("bg-opacity-50")) {
      const modalId = event.target.id;
      if (modalId && modalId.startsWith("comment-modal-")) {
        const executionId = modalId.replace("comment-modal-", "");
        closeCommentModal(executionId);
      }
    }
  });

  // Fermer avec la touche Échap
  document.addEventListener("keydown", function (event) {
    if (event.key === "Escape") {
      const modals = document.querySelectorAll('[id^="comment-modal-"]');
      modals.forEach((modal) => {
        if (modal.style.display === "block") {
          const executionId = modal.id.replace("comment-modal-", "");
          closeCommentModal(executionId);
        }
      });
    }
  });
</script>
